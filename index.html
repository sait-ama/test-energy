<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Neon Tap: Lightning Edition</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #050511;
      --card: #16162e;
      --card-border: #2a2a4a;
      --accent: #b026ff;
      --accent-2: #00f0ff;
      --energy-color: #ffd700;
      --text: #ffffff;
      --text-sec: #8b8bce;
      --green: #26ff85;
      --red: #ff4d4d;
    }
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; outline: none; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100vh; overflow: hidden; 
      display: flex; flex-direction: column;
    }

    /* --- UI --- */
    .header {
      position: fixed; top: 0; left: 0; right: 0; height: 85px;
      padding: 10px 15px; background: rgba(19,19,43,0.95);
      border-bottom: 1px solid var(--card-border); z-index: 100;
      display: flex; flex-direction: column; gap: 5px;
    }
    .top-row { display: flex; justify-content: space-between; align-items: center; }
    .balance { font-size: 24px; font-weight: 900; color: var(--text); }
    .premium-res { font-size: 16px; font-weight: bold; color: var(--energy-color); display: flex; align-items: center; gap: 5px; }
    
    /* –ü–æ–ª–æ—Å–∫–∞ —Å—Ç–∞–º–∏–Ω—ã */
    .stamina-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 5px; }
    .stamina-bar-fill { height: 100%; background: var(--accent-2); width: 100%; transition: width 0.2s; }
    .stamina-text { font-size: 10px; color: var(--text-sec); text-align: center; margin-top: 2px; }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ—Ñ–∏–ª–µ */
    .profile-linker {
      position: fixed; top: 90px; left: 10px; right: 10px;
      background: var(--red); padding: 10px; text-align: center; font-size: 12px;
      border-radius: 8px; cursor: pointer; display: none; z-index: 90;
    }
    .profile-linker.active { display: block; }

    /* --- –≠–ö–†–ê–ù–´ --- */
    .screen {
      position: absolute; top: 85px; bottom: 70px; left: 0; right: 0;
      overflow-y: auto; padding: 20px; 
      background: var(--bg);
      display: none; flex-direction: column; align-items: center;
    }
    .screen.show { display: flex; }
    
    /* –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–µ–Ω */
    #screen-game {
      justify-content: center; 
    }

    /* --- –ö–Ω–æ–ø–∫–∞ –¢–∞–ø–∞ --- */
    .circle-container {
      position: relative; width: 260px; height: 260px; 
      display: flex; justify-content: center; align-items: center;
      margin: auto;
    }
    .tap-btn {
      width: 230px; height: 230px; border-radius: 50%; border: none; cursor: pointer;
      background: radial-gradient(circle at 30% 30%, #2b2b50, #101025);
      box-shadow: 0 0 30px rgba(0, 240, 255, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
      border: 4px solid var(--accent-2);
      z-index: 2;
      transition: transform 0.05s;
    }
    .tap-btn:active { transform: scale(0.95); }
    .tap-btn h1 { margin: 0; font-size: 32px; color: var(--accent-2); text-shadow: 0 0 10px var(--accent-2); pointer-events: none; display: flex; height: 100%; justify-content: center; align-items: center; }

    /* --- –ú–ï–ù–Æ –°–ù–ò–ó–£ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) --- */
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
      background: var(--card); border-top: 1px solid var(--card-border);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 100; padding-bottom: 5px;
    }
    .tab-btn {
      background: transparent; border: none; color: var(--text-sec);
      font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 4px;
      cursor: pointer; flex: 1; height: 100%; justify-content: center;
    }
    .tab-btn.active { color: var(--text); font-weight: bold; }
    .tab-btn.active .tab-icon { color: var(--accent-2); transform: scale(1.1); }
    .tab-icon { font-size: 22px; transition: 0.2s; }

    /* --- –ö–ê–†–¢–û–ß–ö–ò –ú–ê–ì–ê–ó–ò–ù–ê --- */
    .list-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
    .section-title { width: 100%; max-width: 600px; font-size: 14px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 10px; }

    .card {
      background: var(--card); border: 1px solid var(--card-border); border-radius: 12px;
      padding: 12px; display: flex; align-items: center; gap: 12px; width: 100%;
    }
    .card.premium { border: 1px solid var(--energy-color); background: rgba(255, 215, 0, 0.05); }
    .card.locked { opacity: 0.5; filter: grayscale(1); }
    
    .card-icon { font-size: 28px; min-width: 40px; text-align: center; }
    .card-body { flex: 1; }
    .card-name { font-weight: bold; font-size: 15px; }
    .card-lvl { font-size: 11px; color: var(--accent-2); margin-left: 5px; }
    .card-desc { font-size: 11px; color: var(--text-sec); }
    
    .buy-btn {
      border: none; border-radius: 8px; padding: 8px 12px;
      font-weight: bold; font-size: 13px; min-width: 80px;
      background: #333; color: #777;
    }
    .buy-btn.can-buy { background: var(--accent); color: #fff; cursor: pointer; }
    .buy-btn.premium-btn.can-buy { background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; }
    
    /* –í—Å–ø–ª—ã–≤–∞—à–∫–∏ */
    .float-num { position: absolute; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 0.8s ease-out forwards; color: #fff; z-index: 50; }
    .float-num.crit { color: var(--energy-color); font-size: 30px; }
    @keyframes floatUp { to { transform: translateY(-120px); opacity: 0; } }

    /* –ú–æ–¥–∞–ª–∫–∞ –∏ –¢–æ—Å—Ç */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; }
    .modal { background: var(--card); padding: 20px; border-radius: 16px; width: 90%; max-width: 320px; border: 1px solid var(--accent); }
    .inp { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; margin: 10px 0; }
    .toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 1px solid var(--green); color: var(--green); padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    
    /* –¢–æ–ø */
    .rank-row { display: flex; align-items: center; padding: 10px; background: var(--card); border-radius: 10px; border: 1px solid var(--card-border); margin-bottom: 8px; width: 100%; }
    .rank-idx { width: 30px; font-weight: 900; }
    .rank-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .rank-val { color: var(--green); font-weight: bold; }
  </style>
</head>
<body>

  <div id="toast" class="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <div id="profileLinker" class="profile-linker" onclick="openProfileModal()">
    ‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω! –ù–∞–∂–º–∏ —Å—é–¥–∞.
  </div>

  <div class="header">
    <div class="top-row">
      <div>
        <div style="font-size:10px; color:var(--text-sec)">–ú–û–ù–ï–¢–´</div>
        <div class="balance" id="balanceDisplay">0</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px; color:var(--text-sec)">–≠–ù–ï–†–ì–ò–Ø (–ú–û–õ–ù–ò–ò)</div>
        <div class="premium-res">
          <span>‚ö°</span> <span id="upgradeEnergyDisplay">0</span>
        </div>
      </div>
    </div>
    <div>
      <div class="stamina-bar-bg">
        <div class="stamina-bar-fill" id="staminaFill"></div>
      </div>
      <div class="stamina-text" id="staminaText">1000 / 1000</div>
    </div>
  </div>

  <div class="screen show" id="screen-game">
    <div class="circle-container">
      <button class="tap-btn" id="tapBtn"><h1>TAP</h1></button>
    </div>
    <div style="margin-top:20px; text-align:center; color:var(--text-sec); font-size:12px">
      <div id="clickDmg">–£—Ä–æ–Ω: 1</div>
      <div id="autoDmg">–ê–≤—Ç–æ: 0/—Å–µ–∫</div>
    </div>
  </div>

  <div class="screen" id="screen-shop">
    <div class="section-title">–ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–∫–∞—á–∫–∞ (–ú–æ–Ω–µ—Ç—ã)</div>
    <div class="list-container" id="basicList"></div>
  </div>

  <div class="screen" id="screen-premium">
    <div class="section-title" style="color:var(--energy-color)">–≠–ª–∏—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–≠–Ω–µ—Ä–≥–∏—è)</div>
    <div style="font-size:11px; color:#888; margin-bottom:10px; text-align:center">
      1 –≠–Ω–µ—Ä–≥–∏—è = 100 –ú–æ–ª–Ω–∏–π –∏–∑ —Ñ–∞–π–ª–æ–≤ –±–æ—Ç–∞.<br>
      <span id="lightningInfo">–ù–∞–π–¥–µ–Ω–æ: 0</span>
    </div>
    <div class="list-container" id="premiumList"></div>
    <button class="buy-btn" style="margin-top:20px; width:100%; max-width:600px; background:#222; color:#fff; border:1px solid #444" onclick="syncEnergy()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤</button>
  </div>

  <div class="screen" id="screen-top">
    <div class="section-title">–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</div>
    <div class="list-container" id="topList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('game', this)">
      <span class="tab-icon">üéÆ</span> –ò–≥—Ä–∞
    </button>
    <button class="tab-btn" onclick="switchTab('shop', this)">
      <span class="tab-icon">üõ†</span> –ü—Ä–æ–∫–∞—á–∫–∞
    </button>
    <button class="tab-btn" onclick="switchTab('premium', this)">
      <span class="tab-icon" style="color:var(--energy-color)">‚ö°</span> –≠–Ω–µ—Ä–≥–∏—è
    </button>
    <button class="tab-btn" onclick="switchTab('top', this)">
      <span class="tab-icon">üèÜ</span> –¢–æ–ø
    </button>
  </div>

  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h3>–ü—Ä–∏–≤—è–∑–∫–∞ ReManga</h3>
      <p style="font-size:12px; color:#aaa">–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å ReManga:</p>
      <input type="text" class="inp" id="profileInput" placeholder="https://remanga.org/user/..." />
      <button class="buy-btn can-buy" style="width:100%" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="buy-btn" style="width:100%; margin-top:10px; background:transparent" onclick="closeProfileModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

<script>
const tg = window.Telegram?.WebApp; tg?.expand();

// --- –ö–û–ù–§–ò–ì ---
const BASIC_UPGRADES = [
  { id: 'b_click', name: '–°–∏–ª–∞ –¢–∞–ø–∞', desc: '+1 –∫ –∫–ª–∏–∫—É', icon: '‚úä', baseCost: 100, mult: 1.6, max: 20, type: 'click', val: 1 },
  { id: 'b_auto', name: '–ê–≤—Ç–æ-–ë–æ—Ç', desc: '+1 –≤ —Å–µ–∫', icon: 'ü§ñ', baseCost: 250, mult: 1.5, max: 20, type: 'auto', val: 1 },
  { id: 'b_crit', name: '–õ–∏–Ω–∑–∞', desc: '+1% —à–∞–Ω—Å –∫—Ä–∏—Ç–∞', icon: 'üîç', baseCost: 500, mult: 1.8, max: 20, type: 'crit', val: 1 },
  { id: 'b_stamina', name: '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä', desc: '+50 —Å—Ç–∞–º–∏–Ω—ã', icon: 'üîã', baseCost: 300, mult: 1.4, max: 20, type: 'stamina', val: 50 },
  { id: 'b_regen', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', desc: '+1 —Ä–µ–≥–µ–Ω', icon: 'üîå', baseCost: 1000, mult: 1.7, max: 20, type: 'regen', val: 1 }
];

const PREMIUM_UPGRADES = [
  { id: 'p_thunder', name: '–ì—Ä–æ–º–æ–æ—Ç–≤–æ–¥', desc: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫–ª–∏–∫–∞ x2', icon: 'üî®', cost: 1, type: 'clickMult', val: 0.5 },
  { id: 'p_plasma', name: '–ü–ª–∞–∑–º–∞', desc: '+100 –∫ –∫–ª–∏–∫—É', icon: 'üí•', cost: 5, req: {id:'p_thunder', lvl:5}, type: 'clickFlat', val: 100 },
  { id: 'p_static', name: '–°—Ç–∞—Ç–∏–∫–∞', desc: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∞–≤—Ç–æ x2', icon: 'üåê', cost: 1, type: 'autoMult', val: 0.5 },
  { id: 'p_storm', name: '–®—Ç–æ—Ä–º', desc: '+500 –≤ —Å–µ–∫', icon: 'üå™', cost: 5, req: {id:'p_static', lvl:5}, type: 'autoFlat', val: 500 },
  { id: 'p_overload', name: '–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞', desc: '–ö—Ä–∏—Ç —É—Ä–æ–Ω x10', icon: '‚ö°', cost: 3, type: 'critMult', val: 0.5 }
];

const FILES = ['./history_ew.json', './history_ed.json', './history_ea.json'];

let state = {
  balance: 0,
  stamina: 1000,
  lastTs: Date.now(),
  profile: "",
  b_levels: {}, 
  p_levels: {},
  claimedDiff: 0,
  spentEnergy: 0, 
  totalEnergy: 0, 
  name: (tg?.initDataUnsafe?.user?.first_name || "Guest")
};

function load() {
  const raw = localStorage.getItem("neon_ltg_save_v2");
  if (raw) try { state = { ...state, ...JSON.parse(raw) }; } catch(e){}
  try { const p = new URLSearchParams(location.search).get("profile"); if (p) state.profile = normalizeProfile(p); } catch(e){}
  calcStats(); updateUI(); syncEnergy();
}
function save() { state.lastTs = Date.now(); localStorage.setItem("neon_ltg_save_v2", JSON.stringify(state)); }

let lastSent = 0;
function pushToBot() {
  if (Date.now() - lastSent > 30000 && tg?.sendData) {
    lastSent = Date.now(); tg.sendData(JSON.stringify({ type: "sync", state }));
  }
}

let stats = { click: 1, auto: 0, crit: 0, maxStamina: 1000, regen: 1, critMult: 5 };

function calcStats() {
  let s = { click:1, auto:0, crit:0, maxStamina:1000, regen:1, clickMult:1, autoMult:1, critMult:5 };
  
  BASIC_UPGRADES.forEach(u => {
    const lvl = state.b_levels[u.id] || 0;
    if (u.type==='click') s.click += lvl * u.val;
    if (u.type==='auto') s.auto += lvl * u.val;
    if (u.type==='crit') s.crit += lvl * u.val;
    if (u.type==='stamina') s.maxStamina += lvl * u.val;
    if (u.type==='regen') s.regen += lvl * u.val;
  });

  PREMIUM_UPGRADES.forEach(u => {
    const lvl = state.p_levels[u.id] || 0;
    if (u.type==='clickMult') s.clickMult += lvl * u.val;
    if (u.type==='clickFlat') s.click += lvl * u.val;
    if (u.type==='autoMult') s.autoMult += lvl * u.val;
    if (u.type==='autoFlat') s.auto += lvl * u.val;
    if (u.type==='critMult') s.critMult += lvl * u.val;
  });

  stats.click = Math.floor(s.click * s.clickMult);
  stats.auto = Math.floor(s.auto * s.autoMult);
  stats.crit = s.crit;
  stats.maxStamina = s.maxStamina;
  stats.regen = s.regen;
  stats.critMult = s.critMult;
}

setInterval(() => {
  if (stats.auto > 0) state.balance += stats.auto;
  if (state.stamina < stats.maxStamina) state.stamina = Math.min(stats.maxStamina, state.stamina + stats.regen);
  updateUI(); save(); pushToBot();
}, 1000);

document.getElementById('tapBtn').addEventListener('pointerdown', (e) => {
  if (state.stamina >= 1) {
    state.stamina -= 1;
    let dmg = stats.click;
    let isCrit = Math.random() * 100 < stats.crit;
    if (isCrit) dmg = Math.floor(dmg * stats.critMult);
    state.balance += dmg;
    
    const btn = document.getElementById('tapBtn');
    btn.style.transform = "scale(0.95)";
    setTimeout(() => btn.style.transform = "scale(1)", 50);
    createFloat(e.clientX, e.clientY, "+" + fmt(dmg), isCrit);
    updateUI();
  }
});

async function syncEnergy() {
  if (!state.profile) { document.getElementById('profileLinker').classList.add('active'); return; }
  document.getElementById('profileLinker').classList.remove('active');
  
  const btn = document.querySelector('#screen-premium button');
  if(btn) { btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞..."; btn.disabled = true; }
  
  try {
    let totalDiff = 0;
    const norm = normalizeProfile(state.profile);
    for (const file of FILES) {
      try {
        const r = await fetch(file + "?t=" + Date.now());
        if (r.ok) {
          const data = await r.json();
          const row = data.find(x => normalizeProfile(x.profile) === norm);
          if (row && row.diff) totalDiff += row.diff;
        }
      } catch(e){}
    }
    const lifetime = Math.floor(totalDiff / 100);
    state.totalEnergy = Math.max(0, lifetime - state.spentEnergy);
    document.getElementById('lightningInfo').innerText = `–ù–∞–π–¥–µ–Ω–æ: ${totalDiff} –º–æ–ª–Ω–∏–π | –î–æ—Å—Ç—É–ø–Ω–æ: ${state.totalEnergy} —ç–Ω–µ—Ä–≥–∏–∏`;
    showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è OK");
  } catch(e) { showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
  
  if(btn) { btn.innerText = "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤"; btn.disabled = false; }
  updateUI();
}

function normalizeProfile(url) {
  try { return "https://remanga.org/user/" + url.match(/user\/(\d+)/)[1] + "/about"; } catch { return url; }
}

function buyBasic(id) {
  const u = BASIC_UPGRADES.find(x => x.id === id);
  const lvl = state.b_levels[id] || 0;
  if (lvl >= u.max) return;
  const cost = Math.floor(u.baseCost * Math.pow(u.mult, lvl));
  if (state.balance >= cost) {
    state.balance -= cost; state.b_levels[id] = lvl + 1;
    calcStats(); updateUI(); save(); showToast("–ö—É–ø–ª–µ–Ω–æ!");
  }
}

function buyPremium(id) {
  const u = PREMIUM_UPGRADES.find(x => x.id === id);
  const lvl = state.p_levels[id] || 0;
  if (u.req) {
    if ((state.p_levels[u.req.id] || 0) < u.req.lvl) return;
  }
  if (state.totalEnergy >= u.cost) {
    state.totalEnergy -= u.cost; state.spentEnergy += u.cost;
    state.p_levels[id] = lvl + 1;
    calcStats(); updateUI(); save(); showToast("–≠–ª–∏—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ!");
  }
}

function updateUI() {
  document.getElementById('balanceDisplay').innerText = fmt(state.balance);
  document.getElementById('upgradeEnergyDisplay').innerText = state.totalEnergy;
  const pct = (state.stamina / stats.maxStamina) * 100;
  document.getElementById('staminaFill').style.width = pct + "%";
  document.getElementById('staminaText').innerText = `${Math.floor(state.stamina)} / ${Math.floor(stats.maxStamina)}`;
  
  document.getElementById('clickDmg').innerText = `–£—Ä–æ–Ω: ${fmt(stats.click)}`;
  document.getElementById('autoDmg').innerText = `–ê–≤—Ç–æ: ${fmt(stats.auto)}/—Å–µ–∫`;

  renderShop();
}

function renderShop() {
  const bList = document.getElementById('basicList'); bList.innerHTML = "";
  BASIC_UPGRADES.forEach(u => {
    const lvl = state.b_levels[u.id] || 0;
    const cost = Math.floor(u.baseCost * Math.pow(u.mult, lvl));
    const can = state.balance >= cost && lvl < u.max;
    const maxed = lvl >= u.max;
    
    bList.innerHTML += `
    <div class="card">
      <div class="card-icon">${u.icon}</div>
      <div class="card-body">
        <div class="card-name">${u.name} <span class="card-lvl">Lvl ${lvl}</span></div>
        <div class="card-desc">${u.desc}</div>
      </div>
      <button class="buy-btn ${can?'can-buy':''} ${maxed?'maxed':''}" onclick="buyBasic('${u.id}')">
        ${maxed ? 'MAX' : fmt(cost)}
      </button>
    </div>`;
  });

  const pList = document.getElementById('premiumList'); pList.innerHTML = "";
  PREMIUM_UPGRADES.forEach(u => {
    const lvl = state.p_levels[u.id] || 0;
    let locked = false, msg = u.desc;
    if (u.req) {
      if ((state.p_levels[u.req.id]||0) < u.req.lvl) {
        locked = true; msg = `–ù—É–∂–µ–Ω ${PREMIUM_UPGRADES.find(x=>x.id===u.req.id).name} Lvl ${u.req.lvl}`;
      }
    }
    const can = !locked && state.totalEnergy >= u.cost;
    
    pList.innerHTML += `
    <div class="card premium ${locked?'locked':''}">
      <div class="card-icon">${u.icon}</div>
      <div class="card-body">
        <div class="card-name" style="color:var(--energy-color)">${u.name} <span class="card-lvl">Lvl ${lvl}</span></div>
        <div class="card-desc">${msg}</div>
      </div>
      <button class="buy-btn premium-btn ${can?'can-buy':''}" onclick="buyPremium('${u.id}')">
        ‚ö° ${u.cost}
      </button>
    </div>`;
  });
}

async function loadRealTop() {
  const list = document.getElementById('topList'); list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
  try {
    const r = await fetch('./tap_saves.json?t=' + Date.now());
    if(!r.ok) throw new Error();
    const d = await r.json();
    let arr = Object.keys(d).map(k => ({
      name: d[k].name || "ID:"+k, score: (d[k].state?.balance||0), isMe: String(k)===String(tg?.initDataUnsafe?.user?.id)
    }));
    arr.sort((a,b)=>b.score-a.score);
    list.innerHTML = "";
    if(!arr.length) list.innerHTML = "–ü—É—Å—Ç–æ";
    arr.slice(0,50).forEach((p,i)=>{
      list.innerHTML += `<div class="rank-row ${p.isMe?'me':''}">
        <div class="rank-idx">${i+1}</div><div class="rank-name">${p.name}</div><div class="rank-val">${fmt(p.score)}</div>
      </div>`;
    });
  } catch { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞"; }
}

function fmt(n) {
  if (n >= 1e9) return (n/1e9).toFixed(2) + "B";
  if (n >= 1e6) return (n/1e6).toFixed(2) + "M";
  if (n >= 1e3) return (n/1e3).toFixed(1) + "K";
  return Math.floor(n);
}
function createFloat(x,y,t,c) {
  const el = document.createElement('div'); el.className='float-num '+(c?'crit':''); el.textContent=t;
  el.style.left=(x||innerWidth/2)+'px'; el.style.top=(y||innerHeight/2)+'px';
  document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
}
function showToast(m) {
  const t = document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000);
}
function switchTab(n,b) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
  document.getElementById('screen-'+n).classList.add('show');
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  if(n==='top') loadRealTop();
}
function openProfileModal(){document.getElementById('profileModal').style.display='flex'}
function closeProfileModal(){document.getElementById('profileModal').style.display='none'}
function saveProfile(){
  const v=document.getElementById('profileInput').value.trim();
  if(v){ state.profile=normalizeProfile(v); save(); closeProfileModal(); syncEnergy(); }
}

load();
</script>
</body>
</html>